 <!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
     
<!-- begin layouts/head ---------------------------------------------- -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <title>highlandpark.nextdoorneighbors.org</title>

  <link href="/stylesheets/highland_park.css?1317431074" media="all" rel="stylesheet" type="text/css" />

  <script src="/javascripts/prototype.js?1301440019" type="text/javascript"></script>  <script src="/javascripts/application.js?1301440019" type="text/javascript"></script>  <script src="/javascripts/effects.js?1301440019" type="text/javascript"></script>  <script src="/javascripts/dragdrop.js?1301440019" type="text/javascript"></script>  
</head>

<!-- end layouts/head ---------------------------------------------- -->
 <!-- --- begin /layouts/theme_maps.html.erb --------  -->  
<body>
<div id="container">
  <div class="sidebar">
    <div id="side_menu">
      <a href="/welcome">Home</a><br /><br />
      <a href="/theme_maps">GIS Data Maps</a><br /><br />
  
    </div>
  </div>
	
  <style type="text/css">
    .content { padding: 10px; }  /* get rid of extra padding so map can be larger... */
  </style>
  <script src="/javascripts/OpenLayers-2.11/OpenLayers.js?1315754231" type="text/javascript"></script>
	
  <!-- --- end /layouts/theme_maps.html.erb -------- --> 
     <!-- begin layouts/content ------------------------------------ -->
    
    <div class="content">
      
 
      
  <script defer="defer" type="text/javascript">
    var map, drawControls, walk_survey, walk_survey_labels;
    function init() {
      map = new OpenLayers.Map('map', {maxExtent: new OpenLayers.Bounds(1259300,253000,1269500,263500)});
            ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var aerial_high_res = new OpenLayers.Layer.WMS('Aerial High Res',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'aerial_high_res',
          format: 'png',
          transparent: 'false'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:true,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var none = new OpenLayers.Layer.WMS('None',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'none',
          format: 'png',
          transparent: 'false'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:true,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var parcel_outlines = new OpenLayers.Layer.WMS('Parcel Outlines',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'parcel_outlines',
          format: 'png',
          transparent: 'true'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:false,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var parcels = new OpenLayers.Layer.WMS('Parcels',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'parcels',
          format: 'png',
          transparent: 'true'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:false,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var parks = new OpenLayers.Layer.WMS('Parks',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'parks',
          format: 'png',
          transparent: 'true'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:false,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var street_names = new OpenLayers.Layer.WMS('Street Names',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'street_names',
          format: 'png',
          transparent: 'true'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:false,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
          ///// begin map_layers //////////////////////////////////////////////////     
      
      
      var zoning = new OpenLayers.Layer.WMS('Zoning',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walk_survey.map',
        { layers: 'zoning',
          format: 'png',
          transparent: 'true'},
        { 
          //scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:false,
          singleTile:true,
        }
      );
     
      ///// end map_layers ////////////////////////////////////////////////// 
    
           //// begin open_layers_init ////////////////////////////

      map.addLayers([none,aerial_high_res,parcels,zoning,parks,parcel_outlines,street_names]);
      map.zoomToMaxExtent();
      map.addControl(new OpenLayers.Control.Scale('scale'));
      map.addControl(new OpenLayers.Control.MousePosition());
      var layerSwitch = new OpenLayers.Control.LayerSwitcher();
      map.addControl(layerSwitch);
      layerSwitch.maximizeControl();
      
      //// end open_layers_init ////////////////////////////////


            /////// begin open_layers_interactive_init /////////////////////////
      
      var prompt_title = 'prompt'
      var prompt_string = 'enter something'
      
      var exist_geometries = ["LINESTRING(1261927.48747 254284.03830995,1265009.3524725 255923.74853562,1261986.7541047 257030.05904932,1265858.8409027 258136.36956303)"];
      var exist_labels = ["4"];

      OpenLayers.Feature.Vector.style['default']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['temporary']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['default']['strokeColor'] = '#ff0000';
      OpenLayers.Feature.Vector.style['temporary']['strokeColor'] = '#ff7777';
      OpenLayers.Feature.Vector.style['select']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['select']['strokeColor'] = '#3300ff';
      
      var walk_survey = new OpenLayers.Layer.Vector("walk survey",
         { projection: new OpenLayers.Projection("epsg:4326"),
           opacity:0.5,
           rendererOptions: {zIndexing: true}
      } );
      
      var walk_survey_labels = new OpenLayers.Layer.Vector("walk survey Labels",
      { projection: new OpenLayers.Projection("epsg:4326"),
        opacity:0.5,
        styleMap: new OpenLayers.StyleMap({'default':{
          strokeColor: "#ff0000",
          strokeOpacity: .8,
          strokeWidth: 3,
          fillColor: "#FFeeee",
          fillOpacity: 1,
          pointRadius: 12,
          pointerEvents: "visiblePainted",
          label : "${geometry_feature_attribute}",
              
          fontColor: "black",
          fontSize: "20px",
          fontFamily: "Courier New, monospace",
          fontWeight: "bold",
          labelAlign: "cm",
          graphicZIndex: 100,
          labelXOffset: "0",
          labelYOffset: "0"
        }}),
        rendererOptions: {zIndexing: true}
      });
      walk_survey.setZIndex(2);
      walk_survey_labels.setZIndex(1);
      
      map.addLayers([walk_survey, walk_survey_labels]);

       
      /// ----------- callback functions ------------------///
      
      walk_survey_labels.events.register('featureadded', this, function(obj){
          console.log ("label feature added");
          if(obj.feature.attributes.geometry_feature_attribute == null)
          {
              obj.feature.destroy;
              obj.feature.state = OpenLayers.State.DELETE;
          }
      });
      
      walk_survey.events.register('featuresadded', this, function(obj){
          for(i = 0; i < obj.features.length; i = i + 1)
          {
              geometry_feature = obj.features[i];
              if(geometry_feature.attributes.geometry_feature_attribute == null)
              {
                  var geometry_feature_attribute = prompt(prompt_title, prompt_string);
                  geometry_feature.attributes.geometry_feature_attribute = geometry_feature_attribute;
                  if (geometry_feature.attributes.geometry_feature_attribute == null)
                  {
                      //feature.destroy;
                      geometry_feature.state = OpenLayers.State.DELETE;
                  }
              }
          };
          console.log ("featuresadded");
          makeLabeledDots(walk_survey, walk_survey_labels); 
      } );
      
      // update the label layer after editing the lines...
      walk_survey.events.register('afterfeaturemodified', this, function(obj){
          makeLabeledDots(walk_survey, walk_survey_labels);
      } );
    
      var deleteFeature = function(feature) {   // SelectFeature callback function
          select.unselectAll();
         walk_survey.destroyFeatures(feature);
          walk_survey.selectedFeatures = [];
          makeLabeledDots(walk_survey, walk_survey_labels);
      };
       
      var select = new OpenLayers.Control.SelectFeature(walk_survey, {
          onSelect: deleteFeature,  // calls deleteFeature(selected_feature)
          clickout: true
      } );

      /// ----------- add controls for interaction ------------------///
      
      drawControls = {
          line: new OpenLayers.Control.DrawFeature(walk_survey,
                      OpenLayers.Handler.Path),
          modify: new OpenLayers.Control.ModifyFeature(walk_survey),
          select: select  // for deleting lines
      };
      
      for(var key in drawControls) {
          map.addControl(drawControls[key]);
      };
            
      // now add the geometries and label strings from the database-loaded arrays...
      var exist_features = []
      for(i=0; i < exist_geometries.length; i = i + 1)
      {
          var geom = new OpenLayers.Geometry.fromWKT(exist_geometries[i]);
          feature = new OpenLayers.Feature.Vector(geom, {geometry_feature_attribute: exist_labels[i]});
          exist_features[i] = feature;
      };
      
      // this triggers the makeLabeledDots function through
      // the 'featuresadded' event callback      
      walk_survey.addFeatures(exist_features);

     // document.getElementById('noneToggle').checked = true;
     
     ///// end open_layers_interactive_init /////////////////////////////////

    }  // end of init()


            ///// begin open_layers_interactive_functions ////////////////////////////////
      
      function toggleControl(element) {
        for(key in drawControls) {
          var control = drawControls[key];
          if(element.value == key && element.checked) {
            control.activate();
          } else {
            control.deactivate();
          }
        }
        makeLabeledDots(walk_survey, walk_survey_labels);
      }
     
      function update() {
      // reset modification mode
        drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESHAPE;
      }
     
      var geometries = [];
      var geometry_labels = [];
      
      function makeLabeledDots(walk_survey, walk_survey_labels) {
        var lineFeatures = walk_survey.features; //returns: {Array(OpenLayers.Feature.Vector)}               
        walk_survey_labels.destroyFeatures();
      
        for (var i = 0; i < lineFeatures.length; i = i+1) {       
          if (lineFeatures[i] != null) {                  
            var geometry = lineFeatures[i].geometry;
            var nodes = lineFeatures[i].geometry.getVertices();
            var lastNode = nodes[nodes.length -1];
            var pointFeature = new OpenLayers.Feature.Vector(lastNode);
            var count = i + '';
            pointFeature.attributes = {geometry_feature_attribute: lineFeatures[i].attributes.geometry_feature_attribute,
                     whichLine: count};
            console.log("count = %s  attribute = %s", count, lineFeatures[i].attributes.geometry_feature_attribute);
            walk_survey_labels.addFeatures(pointFeature);
            var wktwriter=new OpenLayers.Format.WKT();
            var wkt=wktwriter.write(lineFeatures[i]);
            geometries.push(wkt);
            geometry_labels.push(lineFeatures[i].attributes.geometry_feature_attribute);
          }
        }
        console.log("UPDATE end of make_labeled_dots");
        //update();

        //document.getElementById("geometries").value = JSON.stringify(geometries);
        console.log(("labels").value = JSON.stringify(geometry_labels));
       }
       
     ///// end open_layers_interactive_functions ////////////////////////////////      

  window.onload=init;  
  </script>
  
  <div id="map" class="smallmap"></div>
  <h2 id="title">walk survey </h2>

  
<script type='text/javascript'>

  function saveChanges(){
    new Ajax.Request("/theme_maps/walk_survey/update_geo_db", {
      // method: 'put',
      parameters: {
        id: 'walk_survey',
        contentType: 'text/javascript',
        //labels: geometry_labels.flatten(),
        //geometries: geometries.flatten()
        
        labels: JSON.stringify(geometry_labels),
        geometries: JSON.stringify(geometries)
        //labels: geometry_labels.toString(),
        //geometries: geometries.toString()
      },
      //onSuccess: showResponse,
      //onFailure: showError
    });
  }
  
</script>


        <!--  begin draw_controls ////////////////////////////////////////////////// -->    
  <ul id="controlToggle">
    <li>
      <input type="radio" name="type" value="none" id="noneToggle"
             onclick="toggleControl(this);" checked="checked" />
      <label for="noneToggle">navigate: pan and zoom</label>
    </li>

    <li>
      <input type="radio" name="type" value="line" id="lineToggle" onclick="toggleControl(this);" />
      <label for="lineToggle">draw line, then double-click to end the line</label>
    </li>
    <li>
      <input type="radio" name="type" value="modify" id="modifyToggle"
             onclick="toggleControl(this);" onchange="update();" />
      <label for="modifyToggle">modify a line</label>
    </li>

    <li>
      <input type="radio" name="type" value="select" id="selectToggle"
             onclick="toggleControl(this);" onchange="update();" />
      <label for="selectToggle">delete a line</label>
    </li>
  </ul>
  <!--  end draw_controls ////////////////////////////////////////////////// --> 
    
      <input onclick="saveChanges();" type="button" value="save changes" />




  <a href="/theme_maps">Back</a>

      <br />
      <br />
      <br />
    </div>

    <div id="footer">

      ...
    </div>
    
    <!-- Start of StatCounter Code -->
      <script type="text/javascript">
      var sc_project=7003450; 
      var sc_invisible=1; 
      var sc_security="aa94c436"; 
      </script>
      <script type="text/javascript"
      src="http://www.statcounter.com/counter/counter.js"></script>
      <noscript><div class="statcounter"><a title="tumblr hit counter"
      href="http://statcounter.com/tumblr/" target="_blank"><img
      class="statcounter" src="http://c.statcounter.com/7003450/0/aa94c436/1/"
      alt="tumblr hit counter"></a></div></noscript>
    <!-- End of StatCounter Code -->
   
  </div>

</body>
</html>
<!-- end layouts/content ------------------------------------ -->     

