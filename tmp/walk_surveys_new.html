 <!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
     
<!-- begin layouts/head ---------------------------------------------- -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <title>highlandpark.nextdoorneighbors.org</title>

  <link href="/stylesheets/highland_park.css?1317431074" media="all" rel="stylesheet" type="text/css" />

  <script src="/javascripts/prototype.js?1281040744" type="text/javascript"></script>  <script src="/javascripts/application.js?1281040744" type="text/javascript"></script>  <script src="/javascripts/effects.js?1281040744" type="text/javascript"></script>  <script src="/javascripts/dragdrop.js?1281040744" type="text/javascript"></script></head>

<!-- end layouts/head ---------------------------------------------- -->
<body>
  <div id="banner">
     Highland Park Neighbors
  </div>
  <div id="container">
    <div class="sidebar">
      <div id="side_menu">
        <br /><br />

        <a href="/welcome">Home</a><br /><br />
        <a href="/forums">Discussion<br />Forum</a><br /><br />
        <a href="/theme_maps">GIS Data Maps</a><br /><br />
        <a href="/wiki">Highland Park<br/>Emergency<br/>Preparedness<br/>Guide</a><br /><br />
        <a href="/faq" rel="dropmenu1">FAQ</a><br /><br />

        <a href="/about">About Us</a><br /><br />
        <a href="/contact">Contact</a><br /><br /><br /><br />
        
        
        <a href="/neighbors/44">Update My Info</a><br /><br />
        

        
          <a href="/logout">Log Out</a><br /><br />
        

        
      </div>
    </div>
     <!-- begin layouts/content ------------------------------------ -->

    
    <div class="content">
      
 
      
    
        <link rel="stylesheet" href="style.css" type="text/css" />
        <style type="text/css">
            #controlToggle li {
                list-style: none;
            }
         /*   p {
                width: 512px;
            }  */

            /* avoid pink tiles */
            .olImageLoadError {
                background-color: transparent !important;
            }
        </style>
        <style type="text/css">

         /*   #map {
                width: 900px;
                height: 480px;
                border: 1px solid black;
                padding: 0px;
                margin:0px auto;
                margin-top:30px;
                position:relative;
            }  */
        </style>
       
        <script src="/javascripts/OpenLayers-2.8/OpenLayers.js?1245699139" type="text/javascript"></script>   
        
        <script type="text/javascript">
            
            // to_do: handle (delete) null frequency lines here, not in controller...
            
            var map, drawControls;
                
             var mapserver_url = "http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/field_day_maps.map";

            function init(){
                var i;

                var exist_lines = ["LINESTRING(1264004.8891022 255444.71262597,1265032.1774364 257321.48939028,1265684.1104177 254219.86884294,1266731.1542967 255622.51252995)","LINESTRING(1262602.2454152 254575.46865091,1264913.6441671 254180.35775316,1265506.3105137 255010.09063844,1268430.1311571 254516.20201625)","LINESTRING(1263945.6224676 257143.6894863,1268015.2647144 257479.53374939,1263254.1783965 258467.31099376,1268785.730965 258862.42189151)","LINESTRING(1262404.6899664 255583.00144018,1261950.3124339 258961.19961595,1261318.1349975 255444.71262597,1260844.0019202 259020.46625061)"];
                var exist_freqs = ["4","5","3","6"];

                
                map = new OpenLayers.Map('map');

                var aerial_layer = new OpenLayers.Layer.WMS( "with aerial",
                     mapserver_url,
                     { layers: 'ortho1,ortho2,zoning2,park,Parcel_Clip,Parcel_Clip_Outline,st_address_Clip',
                       format: 'png24',
                       transparent: 'false'},
                      
                     { maxExtent: new OpenLayers.Bounds(1259300,254000,1269500,262500),
                       scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
                       units: 'm',
                       projection:new OpenLayers.Projection("epsg:4326"),
                       gutter:0,
                       ratio:1,
                       isBaselayer:true,
                       singleTile:true
                      }
                );
    
                var no_aerial_layer = new OpenLayers.Layer.WMS( "no aerial",
                     mapserver_url,
                     { layers: 'zoning2,park,Parcel_Clip,Parcel_Clip_Outline,st_address_Clip',
                       format: 'png',
                       transparent: 'false'},
                      
                     { maxExtent: new OpenLayers.Bounds(1259300,254000,1269500,262500),
                       scales: [100,200,400,800,1600,3200,6400,12800,25600,51200],
                       units: 'm',
                       projection: new OpenLayers.Projection("epsg:4326"),
                       gutter:0,
                       ratio:1,
                       isBaselayer:true,
                       singleTile:true
                    }
                );

                OpenLayers.Feature.Vector.style['default']['strokeWidth'] = '4';
                OpenLayers.Feature.Vector.style['temporary']['strokeWidth'] = '4';
                OpenLayers.Feature.Vector.style['default']['strokeColor'] = '#ff0000';
                OpenLayers.Feature.Vector.style['temporary']['strokeColor'] = '#ff7777';
                OpenLayers.Feature.Vector.style['select']['strokeWidth'] = '4';
                OpenLayers.Feature.Vector.style['select']['strokeColor'] = '#3300ff';

                var lineLayer = new OpenLayers.Layer.Vector("Line Layer",
                   { projection: new OpenLayers.Projection("epsg:4326"),
                     opacity:0.5,
                     rendererOptions: {zIndexing: true}
                } );
            
                var lineLabelLayer = new OpenLayers.Layer.Vector("Line Label Layer",
                   { projection: new OpenLayers.Projection("epsg:4326"),
                     opacity:0.5,
                     styleMap: new OpenLayers.StyleMap({'default':{
                        strokeColor: "#ff0000",
                        strokeOpacity: .8,
                        strokeWidth: 3,
                        fillColor: "#FFeeee",
                        fillOpacity: 1,
                        pointRadius: 12,
                        pointerEvents: "visiblePainted",
                        label : "${frequency}",
                        
                        fontColor: "black",
                        fontSize: "20px",
                        fontFamily: "Courier New, monospace",
                        fontWeight: "bold",
                        labelAlign: "cm",
                        graphicZIndex: 100,
                        labelXOffset: "0",
                        labelYOffset: "0"
                    }}),
                     rendererOptions: {zIndexing: true}
                } );
 
                lineLayer.setZIndex(10);
                lineLabelLayer.setZIndex(20);
                 
                /*
                lineLayer.events.register('beforefeatureadded', this, function(obj){
                    console.log ("before line feature added");
                    if(obj.feature.attributes.freq == null)
                    {
                        obj.feature.state = OpenLayers.State.DELETE;
                    }
                } );
                */
                
                lineLabelLayer.events.register('featureadded', this, function(obj){
                    console.log ("label feature added");
                    if(obj.feature.attributes.frequency == null)
                    {
                        obj.feature.destroy;
                        obj.feature.state = OpenLayers.State.DELETE;
                    }
                } );
                
                lineLayer.events.register('featuresadded', this, function(obj){
                    for(i = 0; i < obj.features.length; i = i + 1)
                    {
                        feature = obj.features[i];
                        if(feature.attributes.freq == null)
                        {
                            var n = prompt("Monthly Frequency", "Enter number of trips per month");
                            feature.attributes.freq = n;
                            if (feature.attributes.freq == null)
                            {
                                //feature.destroy;
                                feature.state = OpenLayers.State.DELETE;
                            }
                        }
                    };
                    console.log ("featuresadded");
                    makeLabeledDots(lineLayer, lineLabelLayer); 
                    //lineLayer.refresh();
                    //lineLabelLayer.refresh();
                } );
                
                
                /*
                // add the labels after adding the lines...
                lineLayer.events.register('featureadded', this, function(obj){
                    console.log ("feature added");
                    if(obj.feature.attributes.freq == null)
                    {
                        var n = prompt("Monthly Frequency", "Please enter number of trips per month:");
                        obj.feature.attributes.freq = n;
                    }
                    makeLabeledDots(lineLayer, lineLabelLayer);
                } );
                */

 
                // update the label layer after editing the lines...
                lineLayer.events.register('afterfeaturemodified', this, function(obj){
                    makeLabeledDots(lineLayer, lineLabelLayer);
                } );

                map.addLayers([no_aerial_layer, aerial_layer, lineLayer, lineLabelLayer /*, walk_survey_layer */]);
                map.addControl(new OpenLayers.Control.LayerSwitcher());
                map.addControl(new OpenLayers.Control.MousePosition());
                
                var deleteFeature = function(feature) {   // SelectFeature callback function
                    select.unselectAll();
                    lineLayer.destroyFeatures(feature);
                    lineLayer.selectedFeatures = [];
                    makeLabeledDots(lineLayer, lineLabelLayer);
                 };
                 
                var select = new OpenLayers.Control.SelectFeature(lineLayer,
                {
                    onSelect: deleteFeature,  // calls deleteFeature(selected_feature)
                    clickout: true
                } );

                drawControls = {
                    line: new OpenLayers.Control.DrawFeature(lineLayer,
                                OpenLayers.Handler.Path),
                    modify: new OpenLayers.Control.ModifyFeature(lineLayer),
                    select: select  // for deleting lines
                };

                for(var key in drawControls) {
                    map.addControl(drawControls[key]);
                };
 
                map.zoomToMaxExtent();
                document.getElementById('noneToggle').checked = true;
 
                // now add the walk_survey paths and frequencies from the database-loaded arrays...
 
                var exist_features = []
                for(i=0; i < exist_lines.length; i = i + 1)
                {
                    var geom = new OpenLayers.Geometry.fromWKT(exist_lines[i]);
                    feature = new OpenLayers.Feature.Vector(geom, {freq: exist_freqs[i]});
                    exist_features[i] = feature;
                };
                console.log("adding all existing features");
                lineLayer.addFeatures(exist_features);
                
                // and this triggers the makeLabeledDots function through
                // the 'featuresadded' event callback
                
            } // end of init().

            function update() {
                // reset modification mode
                // drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESHAPE;
            }

            function toggleControl(element) {
                for(key in drawControls) {
                    var control = drawControls[key];
                    if(element.value == key && element.checked) {
                        control.activate();
                    } else {
                        control.deactivate();
                    }
                }
                //update();
            }
            
            function makeLabeledDots(lineLayer, lineLabelLayer) {
                var lineFeatures = lineLayer.features; //returns: {Array(OpenLayers.Feature.Vector)}               
                lineLabelLayer.destroyFeatures();
                
                var line_geometries = [];
                var frequencies = [];
                
                for (var i = 0; i < lineFeatures.length; i = i+1) {       
                    if (lineFeatures[i] != null) {                  
                        var geometry = lineFeatures[i].geometry;
                        var nodes = lineFeatures[i].geometry.getVertices();
                        var lastNode = nodes[nodes.length -1];
                        var pointFeature = new OpenLayers.Feature.Vector(lastNode);
                        var count = i + '';
                        pointFeature.attributes = {frequency: lineFeatures[i].attributes.freq, whichLine: count};
                        lineLabelLayer.addFeatures(pointFeature);
                        var wktwriter=new OpenLayers.Format.WKT();
                        var wkt=wktwriter.write(lineFeatures[i]);
                        line_geometries.push(wkt);
                        frequencies.push(lineFeatures[i].attributes.freq);

                    }
                }

                // store the latest multi-line data for transmitting to controller...
                json_routes = JSON.stringify(line_geometries);
                json_freqs = JSON.stringify(frequencies);
                
                console.log("routes = %s", line_geometries);
                console.log("frequencies = %s", frequencies);

                document.survey_form.elements[1].value = json_routes;
                document.survey_form.elements[2].value = json_freqs;
                

                
                
            }

				    window.onload=init;
				
    </script>



<form action="/walk_surveys" class="new_walk_survey" id="new_walk_survey" method="post" name="survey_form"><div style="margin:0;padding:0;display:inline"><input name="authenticity_token" type="hidden" value="RtcbszCSkk8FH99IGQYjW1S7xpy12klBlV5cQ3Hjm3k=" /></div>
  

        <input id="line_route" name="line[route]" type="hidden" />
        <input id="line2_frequency" name="line2[frequency]" type="hidden" />

        <div id="tags"></div>

        <div id="map" class="smallmap"></div>
        <ul id="controlToggle">
            <li>

                <input type="radio" name="type" value="none" id="noneToggle"
                       onclick="toggleControl(this);" checked="checked" />
                <label for="noneToggle">navigate: pan and zoom</label>
            </li>
            <li>
                <input type="radio" name="type" value="line" id="lineToggle" onclick="toggleControl(this);" />
                <label for="lineToggle">draw line, then double-click to end the line</label>
            </li>
            <li>

                <input type="radio" name="type" value="modify" id="modifyToggle"
                       onclick="toggleControl(this);" onchange="update();" />
                <label for="modifyToggle">modify a line</label>
            </li>
           <li>
                <input type="radio" name="type" value="select" id="selectToggle"
                       onclick="toggleControl(this);" onchange="update();" />
                <label for="selectToggle">delete a line</label>
            </li>

        </ul>

        <div id="docs">


        </div>
  <p>
    <input id="walk_survey_submit" name="commit" type="submit" value="Submit" />
  </p>
</form>

      <br />
      <br />
      <br />
    </div>

    <div id="footer">
      ...
    </div>
    
    <!-- Start of StatCounter Code -->

      <script type="text/javascript">
      var sc_project=7003450; 
      var sc_invisible=1; 
      var sc_security="aa94c436"; 
      </script>
      <script type="text/javascript"
      src="http://www.statcounter.com/counter/counter.js"></script>
      <noscript><div class="statcounter"><a title="tumblr hit counter"
      href="http://statcounter.com/tumblr/" target="_blank"><img
      class="statcounter" src="http://c.statcounter.com/7003450/0/aa94c436/1/"
      alt="tumblr hit counter"></a></div></noscript>
    <!-- End of StatCounter Code -->
   
  </div>
</body>
</html>
<!-- end layouts/content ------------------------------------ --> 
