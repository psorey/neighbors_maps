<!DOCTYPE html>
<html>
<head>
  <title>NeighborsMaps</title>
  <link href="/assets/application.css?body=1" media="screen" rel="stylesheet" />
<link href="/assets/neighbors_maps.css?body=1" media="screen" rel="stylesheet" />
  <script src="/assets/jquery.js?body=1"></script>
<script src="/assets/jquery_ujs.js?body=1"></script>
<script src="/assets/openlayers/OpenLayers.js?body=1"></script>
<script src="/assets/openlayers-rails.js?body=1"></script>
<script src="/assets/neighbors_maps.js?body=1"></script>
<script src="/assets/theme_maps.js?body=1"></script>
<script src="/assets/application.js?body=1"></script>
  <meta content="authenticity_token" name="csrf-param" />
<meta content="I1o0ol8aaI5YiGWiVAI3sbwAf7xB/Sae/Sc7vjzfVg4=" name="csrf-token" />
</head>


<body>
  <div id="container">
    <div class="sidebar">
      <div id="side_menu">
        <a href="/">Home</a><br /><br />
        <a href="/theme_maps">GIS Data Maps</a><br /><br />
          <!-- /////////  begin draw_controls ////////////////////////////////////////////////// -->   
<div class='map_draw_controls'>
  <ul id="controlToggle">
    <li class='border_top_thin'>
      <input type="radio" name="type" value="none" id="noneToggle"
      onclick="toggleControl(this);" checked="checked" />
      <label for="noneToggle">navigate</label>
    </li>
    <li>
      <input type="radio" name="type" value="line" id="lineToggle" onclick="toggleControl(this);" />
      <label for="lineToggle">draw a line<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end: dbl-clck</label>
    </li>
    <li>
      <input type="radio" name="type" value="modify" id="modifyToggle"
      onclick="toggleControl(this);" onchange="update();" />
      <label for="modifyToggle">modify a line</label>
    </li>
    <li>
      <input type="radio" name="type" value="select" id="selectToggle" onclick="toggleControl(this);" />
      <label for="selectToggle">delete a line</label>
    </li>
  </ul>
  <form action="/theme_maps/walking-paths-survey" class="button_to" data-remote="true" method="post"><div><input class="nav_link" id="revert_geo_db" type="submit" value="revert" /><input name="authenticity_token" type="hidden" value="I1o0ol8aaI5YiGWiVAI3sbwAf7xB/Sae/Sc7vjzfVg4=" /></div></form>
  <form action="/theme_maps/walking-paths-survey" class="button_to" data-remote="true" method="post"><div><input class="nav_link" id="update_geo_db" type="submit" value="save" /><input name="authenticity_token" type="hidden" value="I1o0ol8aaI5YiGWiVAI3sbwAf7xB/Sae/Sc7vjzfVg4=" /></div></form>
  <div style="height: 30px; width: 90px;">
    <div id="indicator" style="display: none; height: 20px; text-align: center;" >Edits Saved</div>
  </div>
  <form action="/theme_maps/walking-paths-survey" class="button_to" data-remote="true" method="post"><div><input class="nav_link" id="help" type="submit" value="help" /><input name="authenticity_token" type="hidden" value="I1o0ol8aaI5YiGWiVAI3sbwAf7xB/Sae/Sc7vjzfVg4=" /></div></form>
</div>


<script type='text/javascript'>

  function showHelp(){
    win = new Window('1', {className: "alphacube", title: 'Walking Paths Survey',
        width:340, height:450, top:70, left:100, zIndex:1500,
        destroyOnClose: true });
    win.setAjaxContent("/theme_maps/walking-paths-survey/send_help",{id: 'walking_paths_survey'});
    win.show();
  }


  function revertSaved(){ // returns javascript to refresh the interactive layers...
    emptyFeatures();
    new Ajax.Request("/theme_maps/walking-paths-survey/revert_geo_db", {
      parameters: {
        id: 'walking-paths-survey'
      },
    });
  }

  $('#update_geo_db').click(function() {
    var request = $.ajax({
      url: "/theme_maps/walking-paths-survey/update_geo_db",
      type: "POST",
      data: {geometries: geometries.toSource(), labels: geometry_labels.toSource()},
      //dataType: "html"
    });

    request.done(function( msg ) {
      $("#rails_error").text("it says we're done: " + msg);
    });

    request.fail(function( jqXHR, textStatus ) {
      $("#rails_error").text("error: " + jqXHR.responseXML);
    });
  });

//        onSuccess: function(){
//          $("indicator").show();
//          $("indicator").fade({ duration: 5.0 });
//          }

</script>
<!--  end draw_controls ////////////////////////////////////////////////// --> 

      </div>
    </div>
  </div>

  <style type="text/css">
    .content { padding: 10px; }  /* get rid of extra padding so map can be larger... */
  </style>


  <div class="content">


  <script defer="defer" type="text/javascript">

  var exist_features = [];
  var exist_geometries = [];
  var exist_labels = [];
  var map, drawControls, walking_paths_survey, walking_paths_survey_labels;
  function init() {
    map = new OpenLayers.Map('map', {maxExtent: new OpenLayers.Bounds(1259300,253000,1269500,263500)});
        ///// begin map_layer ///////////////////////////////////////////////
      
      var aerial_high_res = new OpenLayers.Layer.WMS('Aerial High Res',
      'http://localhost/cgi-bin/mapserv?map=/home/paul/mapserver/walking_paths_survey.map',
        { layers: 'aerial_high_res',
          format: 'png',
          transparent: 'false'},
        { 
          scales: [100,200,300,400,500,600,800,1000,1200,1500,2000,4000,8000,12000,18000,24000,32000,48000,56000],
          units: 'm',
          projection:new OpenLayers.Projection("epsg:4326"),
          gutter:0,
          ratio:1,
          isBaselayer:true,
          singleTile:true,
        }
      );
     
      ///// end map_layer //////////////////////////////////////////////////
    ///// begin map_layer //////////////////////////////////////////////////
      

             /////// begin open_layers_interactive_init /////////////////////////

      var prompt_title = 'enter a number'
      var prompt_string = 'estimated trips per month'

     console.log (["LINESTRING (127.98393814009614 90.0, 141.94723633001558 90.0, -164.5783757099416 90.0, -153.64227051008493 90.0, -152.05477138003334 90.0, -144.11727565992624 90.0, 136.1931008999236 90.0, 170.0597492000088 90.0)", "LINESTRING (112.46172429993749 90.0, 95.52840010006912 90.0, -66.00562360999174 90.0, -74.47228569001891 90.0, -2.5056578901130706 90.0, -44.83896836009808 90.0)", "LINESTRING (127.98393814009614 90.0, 129.39504850003868 90.0, -87.00541780004278 90.0, 2.061395199969411 90.0)", "LINESTRING (-118.47009110008366 90.0, 28.528468699892983 90.0)", "LINESTRING (161.5930870999582 90.0, 110.79311449988745 90.0)"]);
     console.log (["5", "3", "7", "20", "6"]);
      exist_geometries = ["LINESTRING (127.98393814009614 90.0, 141.94723633001558 90.0, -164.5783757099416 90.0, -153.64227051008493 90.0, -152.05477138003334 90.0, -144.11727565992624 90.0, 136.1931008999236 90.0, 170.0597492000088 90.0)", "LINESTRING (112.46172429993749 90.0, 95.52840010006912 90.0, -66.00562360999174 90.0, -74.47228569001891 90.0, -2.5056578901130706 90.0, -44.83896836009808 90.0)", "LINESTRING (127.98393814009614 90.0, 129.39504850003868 90.0, -87.00541780004278 90.0, 2.061395199969411 90.0)", "LINESTRING (-118.47009110008366 90.0, 28.528468699892983 90.0)", "LINESTRING (161.5930870999582 90.0, 110.79311449988745 90.0)"];
      exist_labels = ["5", "3", "7", "20", "6"];

      OpenLayers.Feature.Vector.style['default']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['temporary']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['default']['strokeColor'] = '#ff0000';
      OpenLayers.Feature.Vector.style['temporary']['strokeColor'] = '#ff7777';
      OpenLayers.Feature.Vector.style['select']['strokeWidth'] = '4';
      OpenLayers.Feature.Vector.style['select']['strokeColor'] = '#3300ff';

      walking_paths_survey = new OpenLayers.Layer.Vector("Walking Paths Survey",
         { projection: new OpenLayers.Projection("epsg:4326"),
           opacity:0.5,
           rendererOptions: {zIndexing: true}
      } );

      walking_paths_survey_labels = new OpenLayers.Layer.Vector("Walking Paths Survey Labels",
      { projection: new OpenLayers.Projection("epsg:4326"),
        opacity:0.5,
        styleMap: new OpenLayers.StyleMap({'default':{
          strokeColor: "#ff0000",
          strokeOpacity: .8,
          strokeWidth: 3,
          fillColor: "#FFeeee",
          fillOpacity: 1,
          pointRadius: 12,
          pointerEvents: "visiblePainted",
          label : "${geometry_feature_attribute}",
          fontColor: "black",
          fontSize: "20px",
          fontFamily: "Courier New, monospace",
          fontWeight: "bold",
          labelAlign: "cm",
          graphicZIndex: 100,
          labelXOffset: "0",
          labelYOffset: "0"
        }}),
        rendererOptions: {zIndexing: true}
      });
      walking_paths_survey.setZIndex(2);
      walking_paths_survey_labels.setZIndex(1);
      map.addLayers([walking_paths_survey, walking_paths_survey_labels]);

      
      /// ----------- register callbacks ----------------///

      walking_paths_survey_labels.events.register('featureadded', this, function(obj){
          if(obj.feature.attributes.geometry_feature_attribute == null) {
              obj.feature.destroy;
              obj.feature.state = OpenLayers.State.DELETE;
          }
      });
      walking_paths_survey.events.register('featuresadded', this, function(obj){
          for(i = 0; i < obj.features.length; i = i + 1) {
              geometry_feature = obj.features[i];
              if(geometry_feature.attributes.geometry_feature_attribute == null) {
                  var geometry_feature_attribute = prompt(prompt_title, prompt_string);
                  geometry_feature.attributes.geometry_feature_attribute = geometry_feature_attribute;
                  if (geometry_feature.attributes.geometry_feature_attribute == null) {
                      geometry_feature.state = OpenLayers.State.DELETE;
                  }
              }
          };
          console.log ( obj.features.length, "features added");
          makeLabeledDots(walking_paths_survey, walking_paths_survey_labels); 
      } );

      // update the label layer after editing the lines...
      walking_paths_survey.events.register('afterfeaturemodified', this, function(obj){
          makeLabeledDots(walking_paths_survey, walking_paths_survey_labels);
      } );

      var deleteFeature = function(feature) {   // SelectFeature callback function
          select.unselectAll();
         walking_paths_survey.destroyFeatures(feature);
          walking_paths_survey.selectedFeatures = [];
          makeLabeledDots(walking_paths_survey, walking_paths_survey_labels);
      };

      var select = new OpenLayers.Control.SelectFeature(walking_paths_survey, {
          onSelect: deleteFeature,  // calls deleteFeature(selected_feature)
          clickout: true
      } );

      /// ----------- add controls for interaction ------------------ ///
      drawInteractiveControls
      drawControls = {
          line: new OpenLayers.Control.DrawFeature(walking_paths_survey,
                      OpenLayers.Handler.Path),
          modify: new OpenLayers.Control.ModifyFeature(walking_paths_survey),
          select: select  // for deleting lines
      };

      for(var key in drawControls) {
          map.addControl(drawControls[key]);
      };

      // now add the geometries and label strings from the database-loaded arrays...
      buildFeatures(); // using exist_geometries[] and exist_labels[]

     // document.getElementById('noneToggle').checked = true;

     ///// end open_layers_interactive_init /////////////////////////////////

  }  // end of init()
  window.onload=init;
</script>
<div id='rails_error'></div>
  <script type="text/javascript">     
     ///// begin open_layers_interactive_functions ////////////////////////////////
    
      function emptyFeatures(){
        walking_paths_survey.destroyFeatures();
        walking_paths_survey_labels.destroyFeatures();
        exist_geometries = [];
        exist_labels = [];
        exist_features = [];
      }
      
      function buildFeatures(){
        geometries = [];
        geometry_labels = [];
        for(i=0; i < exist_geometries.length; i = i + 1)
        {
          var geom = new OpenLayers.Geometry.fromWKT(unescape(exist_geometries[i]));
          feature = new OpenLayers.Feature.Vector(geom, {geometry_feature_attribute: exist_labels[i]});
          exist_features[i] = feature;
        };
       // this triggers the makeLabeledDots function through the 'featuresadded' event callback      
        walking_paths_survey.addFeatures(exist_features);
      }
      
      
      function toggleControl(element) {
        for(key in drawControls) {
          var control = drawControls[key];
          if(element.value == key && element.checked) {
            control.activate();
          } else {
            control.deactivate();
          }
        }
        makeLabeledDots(walking_paths_survey, walking_paths_survey_labels);
      }
     

      var geometries = [];
      var geometry_labels = [];
       
      function makeLabeledDots(geom_layer, label_layer) {
        var lineFeatures = geom_layer.features; //returns: {Array(OpenLayers.Feature.Vector)}               
        label_layer.destroyFeatures();
        geometries = [];
        geometry_labels = [];
        for (var i = 0; i < lineFeatures.length; i = i+1) {       
          if (lineFeatures[i] != null) {                  
            var geometry = lineFeatures[i].geometry;
            var nodes = lineFeatures[i].geometry.getVertices();
            var lastNode = nodes[nodes.length -1];
            var pointFeature = new OpenLayers.Feature.Vector(lastNode);
            var count = i + '';
            pointFeature.attributes = {
                    geometry_feature_attribute: lineFeatures[i].attributes.geometry_feature_attribute,
                    whichLine: count};
            label_layer.addFeatures(pointFeature);
            var wktwriter=new OpenLayers.Format.WKT();
            var wkt=wktwriter.write(lineFeatures[i]);
            geometries.push(wkt);
            geometry_labels.push(lineFeatures[i].attributes.geometry_feature_attribute);
          }
        }
      }
       
     ///// end open_layers_interactive_functions ////////////////////////////////      
   </script>


<div id="map" class="smallmap"></div>
<h2 id="title">Walking Paths Survey </h2>

<div>
  <a href="/theme_maps/walking-paths-survey/edit">Edit</a>
</div>

      <br />
      <br />
      <br />
    </div>

    <div id="footer" style="height: 15px; padding-top:6px; font-size: 9px; font-weight: lighter; color: #222;">
      ...website by <a href="http://paulsorey.com" style="font-size: 9px; font-weight: lighter;">paulsorey.com</a>...
    </div>
    

   
  </div>
</body>
</html>
<!-- end layouts/content ------------------------------------ --> 
    


